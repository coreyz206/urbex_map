<!DOCTYPE html>
<html>
  <head>
    <title>Urbex Map</title>
    <script src="resources/jquery.js"></script>
    <link rel="icon" href="./img/urbex_favicon.ico">
    <link rel="stylesheet" href="./style.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto&display=swap">
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">
  </head>
  <body>
    <!--DEPRECATED, BACKUP IN CASE API FAILS-->
    <!-- <input type="file" id="file-input" >
    <div id="file-content"></div> -->
    <div id="map"></div>
    <!--Gotta figure out how to deploy multiple sizes of key image-->
    <button id="location-panel-button" class="loc-panel-button">
        Add a location
        <div id="location-panel-content" class="loc-panel-content" onclick="cancelEvent(event)">
            <form id="loc-panel-form">
                <br>Location name:<br>
                <input type="text" name="name"><br>

                <br>Category:<br>
                <select name="category">
                    <option value="good places">Good</option>
                    <option value="questionable places">Questionable</option>
                    <option value="bad places">Bad/Demolished</option>
                </select><br>

                <br>Description:<br>
                <textarea type="text" name="description" rows="4" cols="20"></textarea><br>

                <br>X Coordinate<br>
                <input type="text" name="x">
                <br>Y Coordinate<br>
                <input type="text" name="y"><br>
                <input type="button" value="Select coordinates on map" onclick="getCoords()">
                <br><br>
                <input type="button" value="Submit" onclick="sendData()">
              </form>
        </div>
    </button>
    <div id="search-container">
        <form id="search">
            <input name="search-bar" type="text" placeholder="Search locations" class="search-bar-box">
        </form>
    </div>
    <button id="key-panel-button" class="key-panel-button">
        Show/hide key
        <div id="key-panel-content" class="key-panel-content" onclick="cancelEvent(event)">
            <img src="./img/green_marker.png" alt="good marker" class="key-marker">
            - Good locations<br>
            <img src="./img/yellow_marker.png" alt="okay marker" class="key-marker">
            - Questionable/okay locations<br>
            <img src="./img/red_marker.png" alt="bad marker" class="key-marker">
            - Demolished/bad locations
        </div>
    </button>

    <!-- Script pertaining to the search bar, I had to learn some jQuery here -->
    <script>
    $(document).ready(function () {
      // Listen to submit event on <form> without html
      $('#search').submit(function(e) {
        // Prevent form submission which refreshes page, the important part
        e.preventDefault();
        // Roundabout way of isolating string value from the raw form
        var searchQuery = $(this).serializeArray()[0].value;
        console.log(searchQuery);
        searchFilter(searchQuery);
      });
    });
    
    searchFilter = function(searchQuery) {
      var filterData = placeData;
      for(location of filterData) {
        if(!location.includes(searchQuery)) {
          location = null;
        }
      }
      initMap(filterData);
    }
    </script>

    <!-- Scripts pertaining to the add location button and associated dropdown menu -->
    <script>  
        var spacePressed = false;

        // Expands location panel
        document.getElementById("location-panel-button").addEventListener("click", function(e) {
          // Make sure this runs after space check
          setTimeout(50);
          // Remove focus from expand button
          this.blur();
          document.getElementById("location-panel-content").classList.toggle("active");
          var content = document.getElementById("location-panel-content");
          if (content.style.display === "block" && spacePressed == false) {
            content.style.display = "none";
          } else {
            content.style.display = "block";
            spacePressed = false;
          }
        });

        // Expands key panel
        document.getElementById("key-panel-button").addEventListener("click", function(e) {
          // Remove focus from expand button
          this.blur();
          document.getElementById("key-panel-content").classList.toggle("active");
          var content = document.getElementById("key-panel-content");
          if (content.style.display === "block") {
            content.style.display = "none";
          } else {
            content.style.display = "block";
          }
        });

        // Disable spacebar minimization while in text box
        document.getElementById("location-panel-button").addEventListener("keypress", function(e) {
          if(e.keyCode == 32) {
            spacePressed = true;
          }
        });

        // Yo I forgot but it's important
        function cancelEvent(event) {
          event.stopPropagation();
        }

        // POSTs new locations to the database
        function sendData() {
          var locationSubmit = Object();
          locationSubmit["Name"] = document.getElementById("loc-panel-form").name.value;
          locationSubmit["Category"] = document.getElementById("loc-panel-form").category.value;
          locationSubmit["Description"] = document.getElementById("loc-panel-form").description.value;
          locationSubmit["X Coord"] = document.getElementById("loc-panel-form").x.value;
          locationSubmit["Y Coord"] = document.getElementById("loc-panel-form").y.value;

          // Coordinates by click functions located in initMap

          console.log("Sending request...");
          locationSubmit = JSON.stringify(locationSubmit);
          
          var Http = new XMLHttpRequest();
          var url = 'https://urbexmap.us/api/';
          Http.open('POST', url + "locations");
          Http.setRequestHeader('Content-Type', 'application/json');
          Http.send(locationSubmit);
          Http.onreadystatechange = function(){
            if(this.readyState==4 && this.status==200){
              console.log("Successfully added new location")
              apiCall();
            }
          }
        }

        // Gets coordinates on click and fills form
        function getCoords() {
          google.maps.event.addListener(map, 'click', function(event){
            document.getElementById("loc-panel-form").x.value = event.latLng.lat();
            document.getElementById("loc-panel-form").y.value = event.latLng.lng();
          }) // TODO: remove this listener on form submit ++
        }
    </script>
    <script>
      // DEPRECATED, BACKUP IN CASE API FAILS

      // function readSingleFile(e) {
      //   var file = e.target.files[0];
      //   if (!file) {
      //     return;
      //   }
      //   var reader = new FileReader();
      //   reader.readAsText(file);
      //   reader.onload = function(e) {
      //     var contents = e.target.result;
      //     initMap(contents);
      //   }
      // };
      
      // Sends http request to our API to get JSON file, on success it initiates map w data
      function apiCall() {
        console.log("Requesting locations...");
        var Http = new XMLHttpRequest();
        var url = 'https://urbexmap.us/api/';
        Http.open('GET', url + "locations");
        Http.send();

        Http.onreadystatechange = function(){
          if(this.readyState==4 && this.status==200){
            console.log("Successfully retrieved locations");
            let placeData = JSON.parse(Http.responseText);
            initMap(placeData);
          } else if(this.readyState==4 && this.status!=200){
            alert("Failed to retrieve locations");
          }
        }
      }
      
      // Function to initiate map and add markers. I should split markers into other function
      var map;
      function initMap(placeData) {
        map = new google.maps.Map(document.getElementById('map'), {
          center: {lat: 47.5, lng: -122},
          zoom: 9
        });
        
        var markers = [];
        var descriptionWindows = [];
        var descriptionContent = [];
        var nameWindows = [];
        var nameContent = [];
        var iconColor = "";
        for(i in placeData){
          if(placeData[i]["category"] == "good places"){
            iconColor = './img/green_marker.png';
          } else if(placeData[i]["category"] == "questionable places"){
            iconColor = './img/yellow_marker.png';
          } else {
            iconColor = './img/red_marker.png';
          };
          
          markers[i] = new google.maps.Marker({
            position: {lat: placeData[i]["x"],
                        lng: placeData[i]["y"]},
            map: map,
            title: placeData[i]["name"],
            icon: iconColor
          });

          nameContent[i] = '<div id="title"> <b>' + placeData[i]["name"] + '</b> </div>';
          descriptionContent[i] = '<div id="content">' + placeData[i]["description"] + '</div>';

          descriptionWindows[i] = new google.maps.InfoWindow({
            content: nameContent[i] + descriptionContent[i],
            maxWidth: 500
          });
          nameWindows[i] = new google.maps.InfoWindow({
            content: nameContent[i],
            maxWidth: 300
          });

          function clickListener(i) {
            return function() {
              nameWindows[i].close(map, markers[i]);
              descriptionWindows[i].open(map, markers[i])
            }
          };
          function enterListener(i) {
            return function() {
              nameWindows[i].open(map, markers[i])
            }
          };
          function leaveListener(i) {
            return function() {
              nameWindows[i].close(map, markers[i])
            }
          };

          markers[i].addListener('click', clickListener(i));
          markers[i].addListener('mouseover', enterListener(i));
          markers[i].addListener('mouseout', leaveListener(i));
        }
      }

      // document.getElementById("file-input").addEventListener("change", readSingleFile)
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDvx71KQmfMXV17yo-Ewl0-QRX8kvNhNdI&callback=apiCall"
    async defer></script>
  </body>
</html>
