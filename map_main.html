<!DOCTYPE html>
<html>
  <head>
    <title>Urbex Map</title>
    <link rel="shortcut icon" href="img/urbex_favicon.ico">
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">
    <style>
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
      #map {
        height: 100%;
      }
      /* Optional: Makes the sample page fill the window. */
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
    </style>
  </head>
  <body>
    <input type="file" id="file-input" >
    <div id="file-content"></div>
    <div id="map">
      <img src="./img/key.png" alt="key" style="position:absolute;left:0px;bottom:0px;z-index:99"> 
    </div>
    <script>
      // Only used to get json file into initMap- will be obsoleted when API works
      function readSingleFile(e) {
        var file = e.target.files[0];
        if (!file) {
          return;
        }
        var reader = new FileReader();
        reader.readAsText(file);
        reader.onload = function(e) {
          var contents = e.target.result;
          initMap(contents);
        }
      };

      // 
      var map;
      function initMap(placeRaw) {
        map = new google.maps.Map(document.getElementById('map'), {
          center: {lat: 47.5, lng: -122},
          zoom: 9
        });
        
        //
        placeData = JSON.parse(placeRaw)
        var markers = [];
        var descriptionWindows = [];
        var descriptionContent = [];
        var nameWindows = [];
        var nameContent = [];
        var iconColor = "";
        for(i in placeData){
          if(placeData[i]["Category"] == "good places"){
            iconColor = './img/green_marker.png';
          } else if(placeData[i]["Category"] == "questionable places"){
            iconColor = './img/yellow_marker.png';
          } else {
            iconColor = './img/red_marker.png';
          };
          
          markers[i] = new google.maps.Marker({
            position: {lat: placeData[i]["X Coord"],
                        lng: placeData[i]["Y Coord"]},
            map: map,
            title: placeData[i]["Name"],
            icon: iconColor
          });

          nameContent[i] = '<div id="title"> <b>' + placeData[i]["Name"] + '</b> </div>';
          descriptionContent[i] = '<div id="content">' + placeData[i]["Description"] + '</div>';

          descriptionWindows[i] = new google.maps.InfoWindow({
            content: nameContent[i] + descriptionContent[i],
            maxWidth: 500
          });

          nameWindows[i] = new google.maps.InfoWindow({
            content: nameContent[i],
            maxWidth: 300
          });

          function clickListener(i) {
            return function() {
              nameWindows[i].close(map, markers[i]);
              descriptionWindows[i].open(map, markers[i])
            }
          };

          function enterListener(i) {
            return function() {
              nameWindows[i].open(map, markers[i])
            }
          };

          function leaveListener(i) {
            return function() {
              nameWindows[i].close(map, markers[i])
            }
          };

          markers[i].addListener('click', clickListener(i));
          markers[i].addListener('mouseover', enterListener(i));
          markers[i].addListener('mouseout', leaveListener(i))
        }
      }

      document.getElementById('file-input').addEventListener('change', readSingleFile, false);
    </script>
    <!--
    TODO

    - Add panel for location submitting
    - Add key image in corner of map
    - Comment code

    -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDvx71KQmfMXV17yo-Ewl0-QRX8kvNhNdI"
    async defer></script>
  </body>
</html>