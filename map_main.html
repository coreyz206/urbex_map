<!DOCTYPE html>
<html>
  <head>
    <title>Urbex Map</title>
    <link rel="icon" href="./img/urbex_favicon.ico">
    <link rel="stylesheet" href="./style.css">
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">
  </head>
  <body>
    <!--DEPRECATED, BACKUP IN CASE API FAILS-->
    <!-- <input type="file" id="file-input" >
    <div id="file-content"></div> -->
    <div id="map"></div>

    <!--Gotta figure out how to deploy multiple sizes of key image-->
    <img src="./img/key_small.png" alt="key" class="key">
    <button id="location-panel-button" class="loc-panel-button">
      Add a Location
      <div id="location-panel-content" class="loc-panel-content" onclick="cancelEvent(event)">
          <form id="loc-panel-form">
              Name:<br>
              <input type="text" name="name"><br>

              <br>Category:<br>
              <select name="category">
                  <option value="good places">Good</option>
                  <option value="questionable places">Questionable</option>
                  <option value="bad places">Bad/Demolished</option>
              </select><br>

              <br>Description:<br>
              <textarea type="text" name="description" rows="4" cols="20"></textarea><br>

              <br>X Coordinate<br>
              <input type="text" name="x"><br>
              Y Coordinate<br>
              <input type="text" name="y"><br><br>
              <input type="button" value="Submit" onclick="sendData()">
            </form>
        </div>
    </button>
    <script>  
        document.getElementById("location-panel-button").addEventListener("click", function() {
          document.getElementById("location-panel-content").classList.toggle("active");
          var content = document.getElementById("location-panel-content");
          if (content.style.display === "block") {
            content.style.display = "none";
          } else {
            content.style.display = "block";
          }
        });

        function cancelEvent(event) {
          event.stopPropagation();
        }

        function sendData() {
          var locationSubmit = Object();
          locationSubmit["Name"] = document.getElementById("loc-panel-form").name.value;
          locationSubmit["Category"] = document.getElementById("loc-panel-form").category.value;
          locationSubmit["Description"] = document.getElementById("loc-panel-form").description.value;
          locationSubmit["X Coord"] = document.getElementById("loc-panel-form").x.value;
          locationSubmit["Y Coord"] = document.getElementById("loc-panel-form").y.value;

          console.log("Attempting to POST...");
          locationSubmit = JSON.stringify(locationSubmit);
          
          var Http = new XMLHttpRequest();
          var url = 'http://192.99.247.159:3000/api/';
          Http.open('POST', url + "locations");
          Http.setRequestHeader('Content-Type', 'application/json');
          Http.send(locationSubmit);
          Http.onreadystatechange = function(){
          if(this.readyState==4 && this.status==200){
            console.log("Successfully POSTed new location")
            apiCall();
          }
        }
        }
    </script>
    <script>
      // DEPRECATED, BACKUP IN CASE API FAILS

      // function readSingleFile(e) {
      //   var file = e.target.files[0];
      //   if (!file) {
      //     return;
      //   }
      //   var reader = new FileReader();
      //   reader.readAsText(file);
      //   reader.onload = function(e) {
      //     var contents = e.target.result;
      //     initMap(contents);
      //   }
      // };
      
      // Sends http request to our API to get JSON file, on success it initiates map w data
      function apiCall() {
        console.log("Requesting locations...")
        var Http = new XMLHttpRequest();
        var url = 'http://192.99.247.159:3000/api/';
        Http.open('GET', url + "locations")
        Http.send()

        Http.onreadystatechange = function(){
          if(this.readyState==4 && this.status==200){
            console.log("Successfully retrieved locations")
            initMap(Http.responseText)
          }
        }
      }
      
      // Function to initiate map and add markers. I should split markers into other function
      var map;
      function initMap(placeRaw) {
        map = new google.maps.Map(document.getElementById('map'), {
          center: {lat: 47.5, lng: -122},
          zoom: 9
        });
        
        placeData = JSON.parse(placeRaw);
        var markers = [];
        var descriptionWindows = [];
        var descriptionContent = [];
        var nameWindows = [];
        var nameContent = [];
        var iconColor = "";
        for(i in placeData){
          if(placeData[i]["Category"] == "good places"){
            iconColor = './img/green_marker.png';
          } else if(placeData[i]["Category"] == "questionable places"){
            iconColor = './img/yellow_marker.png';
          } else {
            iconColor = './img/red_marker.png';
          };
          
          markers[i] = new google.maps.Marker({
            position: {lat: placeData[i]["X Coord"],
                        lng: placeData[i]["Y Coord"]},
            map: map,
            title: placeData[i]["Name"],
            icon: iconColor
          });

          nameContent[i] = '<div id="title"> <b>' + placeData[i]["Name"] + '</b> </div>';
          descriptionContent[i] = '<div id="content">' + placeData[i]["Description"] + '</div>';

          descriptionWindows[i] = new google.maps.InfoWindow({
            content: nameContent[i] + descriptionContent[i],
            maxWidth: 500
          });
          nameWindows[i] = new google.maps.InfoWindow({
            content: nameContent[i],
            maxWidth: 300
          });

          function clickListener(i) {
            return function() {
              nameWindows[i].close(map, markers[i]);
              descriptionWindows[i].open(map, markers[i])
            }
          };
          function enterListener(i) {
            return function() {
              nameWindows[i].open(map, markers[i])
            }
          };
          function leaveListener(i) {
            return function() {
              nameWindows[i].close(map, markers[i])
            }
          };

          markers[i].addListener('click', clickListener(i));
          markers[i].addListener('mouseover', enterListener(i));
          markers[i].addListener('mouseout', leaveListener(i))
        }
      }

      // document.getElementById("file-input").addEventListener("change", readSingleFile)
    </script>
    <!--
    TODO

    - Add panel for location submitting
    - Comment code

    -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDvx71KQmfMXV17yo-Ewl0-QRX8kvNhNdI&callback=apiCall"
    async defer></script>
  </body>
</html>